stages:
  - lint
  - test
  - docs
  - release

lint:
  stage: lint
  image: swift:5.10
  script:
    - swift package dump-package > /dev/null
    - swift build
    - |
      if command -v swift-format >/dev/null 2>&1; then
        swift-format lint -r Sources Tests
      else
        echo "swift-format not installed in this image; skipping format lint in GitLab."
      fi

test:
  stage: test
  image: swift:${SWIFT_VERSION}
  parallel:
    matrix:
      - SWIFT_VERSION: ["5.9", "5.10"]
  script:
    - swift test

docs_check:
  stage: docs
  image: swift:5.10
  script:
    - swift package dump-symbol-graph
    - find .build -type f -name 'FractionFormatter.symbols.json' | grep -q .

release_notes:
  stage: release
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - apk add --no-cache git
    - git fetch --tags
    - PREV_TAG="$(git tag --sort=version:refname | tail -n 2 | head -n 1 || true)"
    - |
      if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$CI_COMMIT_TAG" ]; then
        git log --pretty=format:'- %s (%h)' "${PREV_TAG}..${CI_COMMIT_TAG}" > release-notes.md
      else
        git log --pretty=format:'- %s (%h)' -n 50 > release-notes.md
      fi
  artifacts:
    paths:
      - release-notes.md
