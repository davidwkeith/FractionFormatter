stages:
  - lint
  - test
  - release

lint:
  stage: lint
  image: swift:5.10
  script:
    - swift package dump-package > /dev/null
    - swift build

test:
  stage: test
  image: swift:${SWIFT_VERSION}
  parallel:
    matrix:
      - SWIFT_VERSION: ["5.9", "5.10"]
  script:
    - swift test

release_notes:
  stage: release
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - apk add --no-cache git
    - git fetch --tags
    - PREV_TAG="$(git tag --sort=version:refname | tail -n 2 | head -n 1 || true)"
    - |
      if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$CI_COMMIT_TAG" ]; then
        git log --pretty=format:'- %s (%h)' "${PREV_TAG}..${CI_COMMIT_TAG}" > release-notes.md
      else
        git log --pretty=format:'- %s (%h)' -n 50 > release-notes.md
      fi
  artifacts:
    paths:
      - release-notes.md
